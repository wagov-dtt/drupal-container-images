services:
  drupal:
    image: "${DRUPAL_IMAGE_NAME}:${DRUPAL_IMAGE_TAG}"
    container_name: drupal
    environment:
      DB_HOST: drupal-mysql
      DB_PORT: 3306
      DB_DATABASE: drupal
      DB_USERNAME: drupal
      DB_PASSWORD: drupal
      TRUSTED_HOST: .*
    ports:
      - "80:80"
    volumes:
      - clamav-socket:/var/run/clamav
    restart: always
    # Uncomment the volumes line and set to the local path of your Drupal
    # installation, if you need to work with a local codebase.
    # volumes:
    #   - ~/Sites/drupal-container:/var/www/html:rw,delegated
    depends_on:
      mysql:
        condition: service_healthy

  mysql:
    # See: https://hub.docker.com/_/mysql
    image: mysql:8
    container_name: drupal-mysql
    environment:
      MYSQL_RANDOM_ROOT_PASSWORD: 'yes'
      MYSQL_DATABASE: drupal
      MYSQL_USER: drupal
      MYSQL_PASSWORD: drupal
    ports:
      - "3306:3306"
    healthcheck:
      # The official image's entrypoint script includes healthcheck logic
      # that can leverage MYSQL_USER and MYSQL_PASSWORD environment variables.
      # The $$ escapes the $ for the container's shell.
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost", "-u$$MYSQL_USER", "-p$$MYSQL_PASSWORD" ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 20s

  clamav:
    image: clamav/clamav:1.5.1
    container_name: clamav
    environment:
      CLAMD_CONF_MaxDirectoryRecursion: 30
      CLAMD_CONF_MaxFileSize: 100M
      CLAMD_CONF_PCREMaxFileSize: 100M
      CLAMD_CONF_StreamMaxLength: 100M
    ports:
      - "3310:3310"
    volumes:
      - clamav-socket:/tmp

volumes:
  clamav-socket: {}
