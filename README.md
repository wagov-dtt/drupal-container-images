# Drupal container images

**Drupal container images** to be used for **PROD** and **NPE** environments as well as **local dev** environment.

## Architecture

**Base**: Dev container: [devcontainer-base](https://github.com/wagov-dtt/devcontainer-base)

**Package Management**: Hybrid approach - official Debian packages from Dev container + [mise](https://mise.jdx.dev/) for specialized tools.

**Build System**: [Railpack](https://railpack.com/), Docker [BuildKit](https://github.com/moby/buildkit) with docker [buildx](https://github.com/docker/buildx).

**Automation**: [just](https://just.systems/) recipes + GitHub Actions.

### ðŸ”¨ Building container images

#### Architecture of PROD container image

[Caddy](https://caddyserver.com/) **web server** running [FrankenPHP](https://frankenphp.dev/), **Modern PHP App Server**, written in **Go**.

#### Build Drupal container images for specified app (project)

```bash
just build [app_name]
```

**Build** app (project) **container image** based on provided [Railpack](https://railpack.com/) **build plan** supplied to [buildx](https://github.com/docker/buildx) with [BuildKit](https://github.com/moby/buildkit) syntax for [Railpack](https://railpack.com/) **frontend**.

**Execution steps:**

**a.)** 

#### Prepare 

```bash
just prepare [app_name]
```

**Prepare** a **build plan** for [buildx](https://github.com/docker/buildx) to build **container image**.

**Execution steps:**

**a.)** The [Railpack](https://railpack.com/) command: `railpack prepare` is run to **analyze**  application **code** and **follow** provided **configuration** (building steps customisation) to generate a **build plan**.

#### Copy

```bash
just copy [app_name]
```


**Copy** application **code** and **config files** to be used by [Railpack](https://railpack.com/) to prepare **build plan**.

- The **application** is identified / targeted by **name** `[app_name]` (e.g. `jobswa`).

> [!NOTE]
> The `app` directory is populated with **build artifacts**, so everything in the `app` directory is **git-ingored** with an exception to `.gitkeep`.
> 
> **Subdirectories** like `app/jobswa` contain **build artifacts** for specific app (project).
> 
> - The code of the project is copied into `code` directory (shallow clone of the git repository).
> - Configuration files are placed into `config` directory (e.g. `railpack-info.json`, `railpack-plan.json`).

**Execution steps:**

**a.)** `railpack.json` file is copied **from** root directory **to** `app/{project}/code` directory to be picked up by `railpack prepare` command.

- Copying is necessary as using the **command option** with the path to the **config file**: `railpack prepare --config-file railpack.json` does **NOT** work.
- It should be possible to **override** the config file **path** being looked in by setting theÂ `RAILPACK_CONFIG_FILE`Â environment variable to a **path relative to the directory** being built, but it should work very much the same as the `--config-file` **command option**.

**b.)** `Caddyfile` file is copied from root to `app/{project}/code` to be picked up by [Caddy](https://caddyserver.com/) **web server**.

- `Caddyfile` is  [Caddy](https://caddyserver.com/) **configuration format** used by [Caddy](https://caddyserver.com/)  **web server**.
- The configuration defined in `Caddyfile` is used by [FrankenPHP](https://frankenphp.dev/) app server running on [Caddy](https://caddyserver.com/) **web server**.
- The `Caddyfile` in use is based on the [Drupal on FrankenPHP](https://github.com/dunglas/frankenphp-drupal) example (link to the file: [Port the Apache config to Caddyfile](https://github.com/dunglas/frankenphp-drupal/blob/main/Caddyfile)).
- Read more about: [Caddy](https://wagov-dtt.github.io/dalibor-matura/docs/server/Caddy/]), [Caddyfile](https://wagov-dtt.github.io/dalibor-matura/docs/server/Caddyfile/]) or [FrankenPHP](https://wagov-dtt.github.io/dalibor-matura/docs/language/php/FrankenPHP/).

> [!NOTE]
> There is a Drupal.org issue: [Add Caddyfile configuration](https://www.drupal.org/project/drupal/issues/3437187) aiming to introduce a `Caddyfile` configuration to enable Drupal to be served byÂ [Caddy](https://caddyserver.com/) and to make it possible to useÂ [FrankenPHP](https://frankenphp.dev/)Â easily.

#### Clean build artifacts

```bash
just clean
```

**Clean** (remove) **artifacts** that were **prepared for** and **generated by** the container image **building process**.

**Execution steps:**

**a.)** Remove **container images** from Docker.

**b.)** Remove unused **Docker data.** 

**c.)** Remove all **build artifacts**.

## ðŸ“¦ Included Tools

**Cloud**: Docker  
**Development**: Git, [just](https://just.systems/), [mise](https://mise.jdx.dev/)  
**Security**: Trivy

## ðŸ”§ Configuration

### Commands

```bash
just build
just clean
```

### Customization

...

## Features

**Security**: SBOM generation, signed packages, Trivy scanning, minimal attack surface

### Troubleshooting

- **Tool conflicts**: Run `mise install` to refresh tool installations
- **Build cache**: Use `just clean` to reset Docker build cache if needed

## Acknowledgments

- [Debian](https://www.debian.org/) - Stable base operating system
- [Devcontainers](https://containers.dev/) - Development container specification
- [Docker](https://www.docker.com/) - Container platform and BuildKit
- [just](https://just.systems/) - Command runner
- [mise](https://mise.jdx.dev/) - Polyglot tool version manager
- [Railpack](https://railpack.com/) -  Tool for building images from source code

